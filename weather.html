<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-R">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Weather Widget</title>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f0f0; 
            display: grid;
            place-items: center;
            min-height: 100vh;
        }

        .weather-widget {
            /* --- DEFAULT BACKGROUND SET HERE --- */
            background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('https://source.unsplash.com/random/250x300/?sky') no-repeat center center / cover; 
            color: white;
            padding: 20px;
            border-radius: 12px;
            width: 250px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: background-image 0.5s ease-in-out;
        }

        .current-weather {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .current-temp {
            font-size: 3.5rem;
            font-weight: 600;
            line-height: 1;
        }

        .current-conditions {
            text-align: right;
        }

        .current-icon {
            width: 60px;
            height: 60px;
        }

        .current-description {
            font-size: 0.9rem;
            margin-top: -5px;
            text-transform: capitalize;
        }

        .forecast {
            display: flex;
            justify-content: space-between;
            padding: 0 10px;
        }

        .forecast-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.9rem;
        }
        
        .forecast-time {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .forecast-icon {
            width: 40px;
            height: 40px;
        }

        .forecast-temp {
            font-size: 1.1rem;
            font-weight: 500;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <div class="weather-widget">
        
        <div class="current-weather">
            <div class="current-temp" id="current-temp">--°</div>
            <div class="current-conditions">
                <img src="" alt="Weather icon" class="current-icon" id="current-icon">
                <div class="current-description" id="current-description">Loading...</div>
            </div>
        </div>
        
        <div class="forecast">
            <div class="forecast-item">
                <div class="forecast-time" id="forecast-time-1">--:-- --</div>
                <img src="" alt="Icon" class="forecast-icon" id="forecast-icon-1">
                <div class="forecast-temp" id="forecast-temp-1">--°</div>
            </div>
            <div class="forecast-item">
                <div class="forecast-time" id="forecast-time-2">--:-- --</div>
                <img src="" alt="Icon" class="forecast-icon" id="forecast-icon-2">
                <div class="forecast-temp" id="forecast-temp-2">--°</div>
            </div>
        </div>

    </div>

    <script>
        // ------------------------------------------------------------------
        // --- CONFIGURATION: CHANGE THESE VALUES ---
        // ------------------------------------------------------------------

        // 1. Get your free API key from https://openweathermap.org/appid
        const apiKey = 'YOUR_API_KEY_HERE'; 

        // 2. Set your city
        const city = 'New York'; 

        // ------------------------------------------------------------------

        // Base URL for animated icons
        const iconBaseUrl = 'https://cdn.jsdelivr.net/gh/basmilius/weather-icons/production/fill/svg/';
        // Default icon to use on error
        const defaultIcon = 'cloudy.svg';

        const weatherBackgrounds = {
            'clear': 'clear sky', 'clouds': 'cloudy sky', 'rain': 'rainy weather',
            'drizzle': 'drizzle rain', 'thunderstorm': 'thunderstorm lightning',
            'snow': 'snowy landscape', 'mist': 'mist fog', 'fog': 'foggy forest',
            'default': 'weather background'
        };

        function mapOwmIconToSvg(iconCode) {
            const iconMap = {
                '01d': 'clear-day', '01n': 'clear-night',
                '02d': 'partly-cloudy-day', '02n': 'partly-cloudy-night',
                '03d': 'cloudy', '03n': 'cloudy',
                '04d': 'overcast-day', '04n': 'overcast-night',
                '09d': 'drizzle', '09n': 'drizzle',
                '10d': 'partly-cloudy-day-rain', '10n': 'partly-cloudy-night-rain',
                '11d': 'thunderstorms-day-rain', '11n': 'thunderstorms-night-rain',
                '13d': 'partly-cloudy-day-snow', '13n': 'partly-cloudy-night-snow',
                '50d': 'fog-day', '50n': 'fog-night',
            };
            return iconMap[iconCode] || 'cloudy'; // Fallback to 'cloudy'
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp * 1000);
            let hours = date.getHours();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; 
            return `${hours} ${ampm}`;
        }

        function updateBackground(weatherMain) {
            const searchTerm = weatherBackgrounds[weatherMain.toLowerCase()] || weatherBackgrounds['default'];
            const widget = document.querySelector('.weather-widget');
            widget.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('https://source.unsplash.com/random/250x300/?${searchTerm}')`;
        }
        
        /**
         * --- NEW: Function to set default error state ---
         */
        function setErrorState() {
            console.error('Error fetching weather data. Setting default state.');
            
            document.getElementById('current-description').textContent = 'Failed to load';
            document.getElementById('current-temp').textContent = '--°';
            
            // Set default "cloudy" icons
            document.getElementById('current-icon').src = iconBaseUrl + defaultIcon;
            document.getElementById('forecast-icon-1').src = iconBaseUrl + defaultIcon;
            document.getElementById('forecast-icon-2').src = iconBaseUrl + defaultIcon;
            
            // Background is already set by default in CSS, so no action needed here.
        }

        async function fetchWeather() {
            // Check if API key is placeholder
            if (apiKey === 'YOUR_API_KEY_HERE') {
                setErrorState();
                console.error('API key is still the placeholder. Please replace it.');
                document.getElementById('current-description').textContent = 'Set API Key';
                return;
            }

            const apiUrl = `https://api.openweathermap.org/data/2.5/forecast?q=${city}&appid=${apiKey}&units=imperial`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // --- 1. Update Current Weather ---
                const current = data.list[0];
                const currentIconCode = current.weather[0].icon;
                
                document.getElementById('current-temp').textContent = `${Math.round(current.main.temp)}°`;
                document.getElementById('current-description').textContent = current.weather[0].description;
                document.getElementById('current-icon').src = `${iconBaseUrl}${mapOwmIconToSvg(currentIconCode)}.svg`;
                
                updateBackground(current.weather[0].main);

                // --- 2. Update Hourly Forecast ---
                const forecast1 = data.list[1]; 
                const forecast2 = data.list[2]; 

                if (forecast1) {
                    const forecast1IconCode = forecast1.weather[0].icon;
                    document.getElementById('forecast-time-1').textContent = formatTime(forecast1.dt);
                    document.getElementById('forecast-temp-1').textContent = `${Math.round(forecast1.main.temp)}°`;
                    document.getElementById('forecast-icon-1').src = `${iconBaseUrl}${mapOwmIconToSvg(forecast1IconCode)}.svg`;
                }

                if (forecast2) {
                    const forecast2IconCode = forecast2.weather[0].icon;
                    document.getElementById('forecast-time-2').textContent = formatTime(forecast2.dt);
                    document.getElementById('forecast-temp-2').textContent = `${Math.round(forecast2.main.temp)}°`;
                    document.getElementById('forecast-icon-2').src = `${iconBaseUrl}${mapOwmIconToSvg(forecast2IconCode)}.svg`;
                }

            } catch (error) {
                // --- UPDATED CATCH BLOCK ---
                setErrorState();
            }
        }
        
        // --- NEW: Add a listener in case the icons fail to load ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchWeather();
            
            // Add error listeners to all images
            document.querySelectorAll('img').forEach(img => {
                img.addEventListener('error', () => {
                    // If an icon fails to load, replace it with the default
                    console.warn(`Failed to load image: ${img.src}. Replacing with default.`);
                    img.src = iconBaseUrl + defaultIcon;
                });
            });
        });
    </script>

</body>
</html>
